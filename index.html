<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Global Bitcoin Circular Economies</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html, body { height: 100%; margin: 0; font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #map { position: absolute; inset: 56px 0 0 0; }
    header { position: fixed; top: 0; left: 0; right: 0; height: 56px; background: #111; color: #fff; display: flex; align-items: center; gap: 12px; padding: 0 14px; z-index: 1000; }
    header h1 { font-size: 16px; margin: 0 8px 0 0; font-weight: 600; }
    .controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    select, input { height: 32px; padding: 0 10px; border: 1px solid #ccc; border-radius: 6px; }
    .legend { position: fixed; bottom: 12px; left: 12px; background: #fff; padding: 8px 10px; border-radius: 8px; box-shadow: 0 1px 6px rgba(0,0,0,.12); z-index: 999; }
    .legend div { display: flex; align-items: center; gap: 6px; margin: 2px 0; }
    .dot { width: 10px; height: 10px; border-radius: 50%; border: 1px solid #111; display: inline-block; }
    .popup h3 { margin: 0 0 4px; font-size: 16px; }
    .popup .meta { color: #555; margin-bottom: 6px; }
    .popup a { text-decoration: none; }
  </style>
</head>
<body>
<header>
  <h1>BCE Map</h1>
  <div class="controls">
    <label>Status
      <select id="statusFilter">
        <option value="all">All</option>
        <option value="confirmed">Contact confirmed</option>
        <option value="reached">Reached out</option>
        <option value="none">Not contacted</option>
      </select>
    </label>
    <label>Region
      <select id="regionFilter">
        <option value="all">All</option>
        <option>Latin America</option>
        <option>Africa</option>
        <option>Southeast Asia</option>
        <option>Europe</option>
        <option>North America</option>
        <option>Other</option>
      </select>
    </label>
    <input id="search" type="search" placeholder="Search name/city/countryâ€¦" />
  </div>
</header>

<div id="map"></div>

<div class="legend">
  <div><span class="dot" style="background:#16a34a"></span> Contact confirmed</div>
  <div><span class="dot" style="background:#f59e0b"></span> Reached out</div>
  <div><span class="dot" style="background:#ef4444"></span> Not contacted</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const statusColor = s => (s === "confirmed" ? "#16a34a" : s === "reached" ? "#f59e0b" : "#ef4444");

let map, markers = [], data = [];

function initMap() {
  map = L.map('map', { worldCopyJump: true }).setView([15, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'&copy; OpenStreetMap'
  }).addTo(map);
}

function makeMarker(p) {
  const m = L.circleMarker([p.lat, p.lon], {
    radius: 7, fillOpacity: 0.9, weight: 1, color: "#111",
    fillColor: statusColor(p.status || "none")
  });
  const html = `
    <div class="popup">
      <h3>${p.name}</h3>
      <div class="meta">${p.city || ""}${p.city && p.country ? ", " : ""}${p.country || ""}</div>
      ${p.note ? `<div style="margin:6px 0">${p.note}</div>` : ""}
      ${p.link ? `<a href="${p.link}" target="_blank" rel="noopener">Open profile</a>` : ""}
    </div>`;
  m.bindPopup(html);
  m.point = p; // attach for filtering
  return m;
}

function render() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  const statusVal = document.getElementById('statusFilter').value;
  const regionVal = document.getElementById('regionFilter').value;
  const q = document.getElementById('search').value.trim().toLowerCase();

  const filtered = data.filter(p => {
    const okStatus = statusVal === 'all' || (p.status || 'none') === statusVal;
    const okRegion = regionVal === 'all' || (p.region || 'Other') === regionVal;
    const text = `${p.name||""} ${p.city||""} ${p.country||""}`.toLowerCase();
    const okSearch = !q || text.includes(q);
    return okStatus && okRegion && okSearch;
  });

  filtered.forEach(p => {
    const m = makeMarker(p).addTo(map);
    markers.push(m);
  });

  if (filtered.length) {
    const group = L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.25), { animate: false });
  }
}

async function loadData() {
  const res = await fetch('bces.json');
  data = await res.json();
  render();
}

// events
['statusFilter','regionFilter','search'].forEach(id => {
  document.addEventListener('input', e => {
    if (e.target && e.target.id === id) render();
  });
});

initMap();
loadData();
</script>
</body>
</html>